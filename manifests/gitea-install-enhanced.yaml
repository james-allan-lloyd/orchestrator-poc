apiVersion: v1
kind: Namespace
metadata:
  name: gitea
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitea-storage
  namespace: gitea
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-init
  namespace: gitea
data:
  init_directory_structure.sh: |-
    #!/usr/bin/env bash
    set -euo pipefail
    set -x
    
    # Create necessary directories (ownership will be set by PVC and securityContext)
    mkdir -p /data/git/.ssh
    chmod -R 700 /data/git/.ssh
    mkdir -p /data/gitea/conf
    mkdir -p /data/gitea/log
    mkdir -p /data/gitea/sessions
    mkdir -p /data/git/gitea-repositories
    mkdir -p /data/git/lfs
    
    # Prepare temp directory structure
    mkdir -p "${GITEA_TEMP}"
    chmod ug+rwx "${GITEA_TEMP}"
    
    # Verify we can write to data directory
    touch /data/.write-test && rm /data/.write-test
    echo "Directory structure initialized successfully"
    
  config_environment.sh: |-
    #!/bin/bash
    set -euo pipefail
    
    echo "Generating app.ini configuration with environment variables..."
    
    # Generate complete app.ini with secrets from environment
    cat > /data/gitea/conf/app.ini << EOF
    APP_NAME = Gitea: Git with a cup of tea
    RUN_MODE = prod
    RUN_USER = git

    [database]
    DB_TYPE = ${GITEA__DATABASE__DB_TYPE}
    PATH = ${GITEA__DATABASE__PATH}

    [repository]
    ROOT = ${GITEA__REPOSITORY__ROOT}

    [server]
    APP_DATA_PATH = /data/gitea
    DOMAIN = ${GITEA__SERVER__DOMAIN}
    SSH_DOMAIN = ${GITEA__SERVER__DOMAIN}
    HTTP_PORT = ${GITEA__SERVER__HTTP_PORT}
    ROOT_URL = ${GITEA__SERVER__ROOT_URL}
    DISABLE_SSH = false
    SSH_PORT = ${GITEA__SERVER__SSH_PORT}
    SSH_LISTEN_PORT = ${GITEA__SERVER__SSH_LISTEN_PORT}
    LFS_START_SERVER = ${GITEA__SERVER__LFS_START_SERVER}
    LFS_CONTENT_PATH = ${GITEA__SERVER__LFS_CONTENT_PATH}
    LFS_JWT_SECRET = ${GITEA__SERVER__LFS_JWT_SECRET}
    OFFLINE_MODE = false

    [mailer]
    ENABLED = ${GITEA__MAILER__ENABLED}

    [service]
    REGISTER_EMAIL_CONFIRM = false
    ENABLE_NOTIFY_MAIL = false
    DISABLE_REGISTRATION = ${GITEA__SERVICE__DISABLE_REGISTRATION}
    ALLOW_ONLY_EXTERNAL_REGISTRATION = false
    ENABLE_CAPTCHA = false
    REQUIRE_SIGNIN_VIEW = ${GITEA__SERVICE__REQUIRE_SIGNIN_VIEW}
    DEFAULT_KEEP_EMAIL_PRIVATE = false
    DEFAULT_ALLOW_CREATE_ORGANIZATION = false

    [picture]
    DISABLE_GRAVATAR = false
    ENABLE_FEDERATED_AVATAR = true

    [openid]
    ENABLE_OPENID_SIGNIN = false
    ENABLE_OPENID_SIGNUP = false

    [session]
    PROVIDER = ${GITEA__SESSION__PROVIDER}
    PROVIDER_CONFIG = ${GITEA__SESSION__PROVIDER_CONFIG}

    [log]
    MODE = file
    LEVEL = ${GITEA__LOG__LEVEL}
    ROOT_PATH = ${GITEA__LOG__ROOT_PATH}

    [security]
    INSTALL_LOCK = ${GITEA__SECURITY__INSTALL_LOCK}
    INTERNAL_TOKEN = ${GITEA__SECURITY__INTERNAL_TOKEN}
    SECRET_KEY = ${GITEA__SECURITY__SECRET_KEY}

    [oauth2]
    JWT_SECRET = ${GITEA__OAUTH2__JWT_SECRET}

    [actions]
    ENABLED = ${GITEA__ACTIONS__ENABLED}
    DEFAULT_ACTIONS_URL = ${GITEA__ACTIONS__DEFAULT_ACTIONS_URL}
    EOF

    echo "Configuration file generated successfully"
    ls -la /data/gitea/conf/app.ini
    
  init_gitea.sh: |-
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Set config file path
    GITEA_CONFIG="/data/gitea/conf/app.ini"
    
    echo "Initializing Gitea database..."
    gitea --config "$GITEA_CONFIG" migrate
    
    function configure_admin_user() {
      echo "Configuring admin user: ${GITEA_ADMIN_USERNAME}"
      local ACCOUNT_ID=$(gitea --config "$GITEA_CONFIG" admin user list --admin | grep -e "\s\+${GITEA_ADMIN_USERNAME}\s\+" | awk -F " " "{printf \$1}" || echo "")
      if [[ -z "${ACCOUNT_ID}" ]]; then
        echo "Creating admin user '${GITEA_ADMIN_USERNAME}'..."
        gitea --config "$GITEA_CONFIG" admin user create --admin \
          --username "${GITEA_ADMIN_USERNAME}" \
          --password "${GITEA_ADMIN_PASSWORD}" \
          --email "admin@gitea.local" \
          --must-change-password=false
        echo "Admin user created successfully"
      else
        echo "Admin user '${GITEA_ADMIN_USERNAME}' exists. Updating password..."
        gitea --config "$GITEA_CONFIG" admin user change-password \
          --username "${GITEA_ADMIN_USERNAME}" \
          --password "${GITEA_ADMIN_PASSWORD}" \
          --must-change-password=false
        echo "Password updated successfully"
      fi
    }
    
    configure_admin_user
    echo "Gitea initialization completed"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitea
  namespace: gitea
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitea
  template:
    metadata:
      labels:
        app: gitea
    spec:
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
      initContainers:
      - name: 1-init-directories
        image: docker.gitea.com/gitea:1.25-rootless
        command: ["/usr/sbin/init_directory_structure.sh"]
        env:
        - name: GITEA_WORK_DIR
          value: /data
        - name: GITEA_TEMP
          value: /tmp/gitea
        volumeMounts:
        - name: init
          mountPath: /usr/sbin
        - name: data
          mountPath: /data
        - name: temp
          mountPath: /tmp
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          
      - name: 2-configure-gitea
        image: docker.gitea.com/gitea:1.25-rootless
        command: ["/usr/sbin/config_environment.sh"]
        env:
        - name: GITEA_WORK_DIR
          value: /data
        - name: GITEA_TEMP
          value: /tmp/gitea
        # Database configuration
        - name: GITEA__DATABASE__DB_TYPE
          value: "sqlite3"
        - name: GITEA__DATABASE__PATH
          value: "/data/gitea/gitea.db"
        # Security configuration
        - name: GITEA__SECURITY__INSTALL_LOCK
          value: "true"
        - name: GITEA__SECURITY__INTERNAL_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-security
              key: internal-token
        - name: GITEA__SECURITY__SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: gitea-security
              key: secret-key
        # OAuth2 configuration
        - name: GITEA__OAUTH2__JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gitea-security
              key: jwt-secret
        # Server configuration
        - name: GITEA__SERVER__DOMAIN
          value: "gitea-http.gitea.svc.cluster.local"
        - name: GITEA__SERVER__ROOT_URL
          value: "https://gitea-http.gitea.svc.cluster.local:443"
        - name: GITEA__SERVER__HTTP_PORT
          value: "3000"
        - name: GITEA__SERVER__SSH_PORT
          value: "22"
        - name: GITEA__SERVER__SSH_LISTEN_PORT
          value: "22"
        - name: GITEA__SERVER__LFS_START_SERVER
          value: "true"
        - name: GITEA__SERVER__LFS_CONTENT_PATH
          value: "/data/git/lfs"
        - name: GITEA__SERVER__LFS_JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gitea-security
              key: lfs-jwt-secret
        # Repository configuration
        - name: GITEA__REPOSITORY__ROOT
          value: "/data/git/gitea-repositories"
        # Actions configuration
        - name: GITEA__ACTIONS__ENABLED
          value: "true"
        - name: GITEA__ACTIONS__DEFAULT_ACTIONS_URL
          value: "https://github.com"
        # Log configuration
        - name: GITEA__LOG__LEVEL
          value: "Info"
        - name: GITEA__LOG__ROOT_PATH
          value: "/data/gitea/log"
        # Session configuration
        - name: GITEA__SESSION__PROVIDER
          value: "file"
        - name: GITEA__SESSION__PROVIDER_CONFIG
          value: "/data/gitea/sessions"
        # Service configuration
        - name: GITEA__SERVICE__DISABLE_REGISTRATION
          value: "false"
        - name: GITEA__SERVICE__REQUIRE_SIGNIN_VIEW
          value: "false"
        # Mailer configuration (disabled)
        - name: GITEA__MAILER__ENABLED
          value: "false"
        volumeMounts:
        - name: init
          mountPath: /usr/sbin
        - name: data
          mountPath: /data
        - name: temp
          mountPath: /tmp
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          
      - name: 3-init-gitea
        image: docker.gitea.com/gitea:1.25-rootless
        command: ["/usr/sbin/init_gitea.sh"]
        env:
        - name: GITEA_WORK_DIR
          value: /data
        - name: GITEA_TEMP
          value: /tmp/gitea
        # Admin user configuration
        - name: GITEA_ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-admin
              key: username
        - name: GITEA_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitea-admin
              key: password
        volumeMounts:
        - name: init
          mountPath: /usr/sbin
        - name: data
          mountPath: /data
        - name: temp
          mountPath: /tmp
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          
      containers:
      - name: gitea
        image: docker.gitea.com/gitea:1.25-rootless
        imagePullPolicy: Always
        env:
        - name: GITEA_WORK_DIR
          value: /data
        - name: GITEA_TEMP
          value: /tmp/gitea
        - name: TMPDIR
          value: /tmp/gitea
        - name: GITEA_APP_INI
          value: /data/gitea/conf/app.ini
        ports:
        - name: ssh
          containerPort: 22
        - name: http
          containerPort: 3000
        livenessProbe:
          failureThreshold: 10
          initialDelaySeconds: 200
          periodSeconds: 10
          successThreshold: 1
          tcpSocket:
            port: http
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          tcpSocket:
            port: http
          timeoutSeconds: 1
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - SYS_CHROOT
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: false
          runAsGroup: 1000
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
        - name: temp
          mountPath: /tmp
        - name: data
          mountPath: /data
      volumes:
      - name: init
        configMap:
          name: gitea-init
          defaultMode: 0755
      - name: data
        persistentVolumeClaim:
          claimName: gitea-storage
      - name: temp
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: gitea-ssh
  namespace: gitea
spec:
  ports:
  - name: ssh
    port: 22
    protocol: TCP
    targetPort: 22
    nodePort: 30222
  selector:
    app: gitea
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: gitea-http
  namespace: gitea
spec:
  ports:
  - name: http
    port: 443
    protocol: TCP
    targetPort: 3000
    nodePort: 31333
  selector:
    app: gitea
  type: NodePort