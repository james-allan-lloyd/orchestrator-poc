name: Test Kratix Team Promise

on:
  push:
    branches: [main, feature/fix-github]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run unit tests
        run: |
          cd tests
          python -m pytest unit/ -v --tb=short
        env:
          PYTHONPATH: ../promises/team-promise/workflows/resource/configure/team-configure/python/scripts

      - name: Run contract tests
        run: |
          cd tests
          python -m pytest contract/ -v --tb=short

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"
          cache: false

      - name: Cache Kratix CLI
        id: kratix-cli-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/go/bin/kratix
            ~/go/pkg/mod
          key: kratix-cli-${{ runner.os }}-go1.21-week${{ github.run_number }}
          restore-keys: |
            kratix-cli-${{ runner.os }}-go1.21-

      - name: Install Kratix CLI
        if: steps.kratix-cli-cache.outputs.cache-hit != 'true'
        run: go install github.com/syntasso/kratix-cli/cmd/kratix@latest

      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: kratix-test
          config: manifests/kind-cluster-config.yaml

      - name: Install Kratix
        run: |
          kubectl apply -f https://github.com/syntasso/kratix/releases/download/latest/kratix-quick-start-installer.yaml

          echo "Waiting for quick-start installer job to complete..."
          SECONDS=0
          while ! kubectl wait --for=condition=complete job/kratix-quick-start-installer --timeout=30s 2>/dev/null; do
            echo "[${SECONDS}s] Installer still running..."
            kubectl get jobs --no-headers 2>/dev/null || true
            kubectl get pods --no-headers 2>/dev/null | head -10 || true

            # Fail fast if the job has failed
            JOB_FAILED=$(kubectl get job kratix-quick-start-installer -o jsonpath='{.status.failed}' 2>/dev/null || echo "0")
            if [ "${JOB_FAILED:-0}" -ge 1 ]; then
              echo "FAILED: Installer job has ${JOB_FAILED} failed attempt(s)"
              echo ""
              echo "=== Pod status ==="
              kubectl get pods --selector=job-name=kratix-quick-start-installer -o wide 2>/dev/null
              echo ""
              echo "=== Pod logs ==="
              for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
                echo "--- $pod ---"
                kubectl logs "$pod" --all-containers --tail=50 2>/dev/null || echo "No logs"
              done
              echo ""
              echo "=== Pod events ==="
              kubectl describe pods --selector=job-name=kratix-quick-start-installer 2>/dev/null | grep -A 20 "^Events:" || true
              exit 1
            fi

            if [ "$SECONDS" -ge 420 ]; then
              echo "TIMEOUT after ${SECONDS}s"
              exit 1
            fi
          done
          echo "Installer job completed in ${SECONDS}s"

          echo "Waiting for Kratix pods to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kratix -n kratix-platform-system --timeout=120s

      - name: Debug Kratix install failure
        if: failure()
        run: |
          echo "=== Cluster nodes ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== All pods (all namespaces) ==="
          kubectl get pods -A -o wide
          echo ""
          echo "=== Jobs ==="
          kubectl get jobs -A -o wide
          echo ""
          echo "=== Installer job description ==="
          kubectl describe job/kratix-quick-start-installer 2>/dev/null || echo "Job not found"
          echo ""
          echo "=== Installer pod logs ==="
          for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- Pod: $pod ---"
            kubectl logs "$pod" --all-containers --tail=80 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Kratix platform pods ==="
          kubectl get pods -n kratix-platform-system -o wide 2>/dev/null || echo "Namespace not found"
          echo ""
          echo "=== Kratix platform pod logs ==="
          for pod in $(kubectl get pods -n kratix-platform-system -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- Pod: $pod ---"
            kubectl logs -n kratix-platform-system "$pod" --all-containers --tail=40 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Events (sorted by time) ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -30

      - name: Apply Kratix UID 65534 patch
        run: |
          cat >/tmp/kratix-user-patch.yaml <<'PATCH'
          spec:
            template:
              spec:
                containers:
                - name: manager
                  env:
                  - name: HOME
                    value: /tmp
                  - name: USER
                    value: kratix
                  - name: GIT_AUTHOR_NAME
                    value: kratix
                  - name: GIT_AUTHOR_EMAIL
                    value: kratix@platform.local
                  - name: GIT_COMMITTER_NAME
                    value: kratix
                  - name: GIT_COMMITTER_EMAIL
                    value: kratix@platform.local
                  securityContext:
                    runAsUser: 65534
                    runAsGroup: 65534
                    runAsNonRoot: true
          PATCH
          kubectl patch deployment kratix-platform-controller-manager -n kratix-platform-system --patch-file /tmp/kratix-user-patch.yaml
          kubectl wait --for=condition=available deployment/kratix-platform-controller-manager -n kratix-platform-system --timeout=180s

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run integration tests
        run: |
          cd tests
          python -m pytest integration/ -v --tb=short
        env:
          KUBECONFIG: /home/runner/.kube/config

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"
          cache: false

      - name: Cache Kratix CLI
        id: kratix-cli-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/go/bin/kratix
            ~/go/pkg/mod
          key: kratix-cli-${{ runner.os }}-go1.21-week${{ github.run_number }}
          restore-keys: |
            kratix-cli-${{ runner.os }}-go1.21-

      - name: Install Kratix CLI
        if: steps.kratix-cli-cache.outputs.cache-hit != 'true'
        run: go install github.com/syntasso/kratix-cli/cmd/kratix@latest

      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: kratix-e2e
          config: manifests/kind-cluster-config.yaml

      - name: Install Kratix
        run: |
          kubectl apply -f https://github.com/syntasso/kratix/releases/download/latest/kratix-quick-start-installer.yaml

          echo "Waiting for quick-start installer job to complete..."
          SECONDS=0
          while ! kubectl wait --for=condition=complete job/kratix-quick-start-installer --timeout=30s 2>/dev/null; do
            echo "[${SECONDS}s] Installer still running..."
            kubectl get jobs --no-headers 2>/dev/null || true
            kubectl get pods --no-headers 2>/dev/null | head -10 || true

            # Fail fast if the job has failed
            JOB_FAILED=$(kubectl get job kratix-quick-start-installer -o jsonpath='{.status.failed}' 2>/dev/null || echo "0")
            if [ "${JOB_FAILED:-0}" -ge 1 ]; then
              echo "FAILED: Installer job has ${JOB_FAILED} failed attempt(s)"
              echo ""
              echo "=== Pod status ==="
              kubectl get pods --selector=job-name=kratix-quick-start-installer -o wide 2>/dev/null
              echo ""
              echo "=== Pod logs ==="
              for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
                echo "--- $pod ---"
                kubectl logs "$pod" --all-containers --tail=50 2>/dev/null || echo "No logs"
              done
              echo ""
              echo "=== Pod events ==="
              kubectl describe pods --selector=job-name=kratix-quick-start-installer 2>/dev/null | grep -A 20 "^Events:" || true
              exit 1
            fi

            if [ "$SECONDS" -ge 420 ]; then
              echo "TIMEOUT after ${SECONDS}s"
              exit 1
            fi
          done
          echo "Installer job completed in ${SECONDS}s"

          echo "Waiting for Kratix pods to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kratix -n kratix-platform-system --timeout=120s

      - name: Debug Kratix install failure
        if: failure()
        run: |
          echo "=== Cluster nodes ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== All pods (all namespaces) ==="
          kubectl get pods -A -o wide
          echo ""
          echo "=== Jobs ==="
          kubectl get jobs -A -o wide
          echo ""
          echo "=== Installer job description ==="
          kubectl describe job/kratix-quick-start-installer 2>/dev/null || echo "Job not found"
          echo ""
          echo "=== Installer pod logs ==="
          for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- Pod: $pod ---"
            kubectl logs "$pod" --all-containers --tail=80 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Kratix platform pods ==="
          kubectl get pods -n kratix-platform-system -o wide 2>/dev/null || echo "Namespace not found"
          echo ""
          echo "=== Kratix platform pod logs ==="
          for pod in $(kubectl get pods -n kratix-platform-system -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- Pod: $pod ---"
            kubectl logs -n kratix-platform-system "$pod" --all-containers --tail=40 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Events (sorted by time) ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -30

      - name: Apply Kratix UID 65534 patch
        run: |
          cat >/tmp/kratix-user-patch.yaml <<'PATCH'
          spec:
            template:
              spec:
                containers:
                - name: manager
                  env:
                  - name: HOME
                    value: /tmp
                  - name: USER
                    value: kratix
                  - name: GIT_AUTHOR_NAME
                    value: kratix
                  - name: GIT_AUTHOR_EMAIL
                    value: kratix@platform.local
                  - name: GIT_COMMITTER_NAME
                    value: kratix
                  - name: GIT_COMMITTER_EMAIL
                    value: kratix@platform.local
                  securityContext:
                    runAsUser: 65534
                    runAsGroup: 65534
                    runAsNonRoot: true
          PATCH
          kubectl patch deployment kratix-platform-controller-manager -n kratix-platform-system --patch-file /tmp/kratix-user-patch.yaml
          kubectl wait --for=condition=available deployment/kratix-platform-controller-manager -n kratix-platform-system --timeout=180s

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Build team-configure container
        run: |
          cd promises/team-promise/workflows/resource/configure/team-configure/python
          docker build -t team-configure:test .

      - name: Load container image into Kind
        run: |
          kind load docker-image team-configure:test --name kratix-e2e

      - name: Run end-to-end tests
        run: |
          cd tests
          python -m pytest e2e/ -v --tb=short -s
        env:
          KUBECONFIG: /home/runner/.kube/config
          CONTAINER_IMAGE: team-configure:test

  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          # Install yq for YAML validation
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Validate Promise YAML
          yq eval '.' promises/team-promise/promise.yaml > /dev/null

          # Validate example resource
          yq eval '.' promises/team-promise/example-resource.yaml > /dev/null

          # Validate test fixtures
          yq eval '.' tests/unit/fixtures/*.yaml > /dev/null

      - name: Validate Dockerfile
        run: |
          # Basic Dockerfile validation
          docker run --rm -i hadolint/hadolint < promises/team-promise/workflows/resource/configure/team-configure/python/Dockerfile || true

      - name: Check Python syntax
        run: |
          python -m py_compile promises/team-promise/workflows/resource/configure/team-configure/python/scripts/configure.py
          python -m py_compile tests/unit/test_configure.py
          python -m py_compile tests/integration/test_promise_deployment.py
          python -m py_compile tests/contract/test_api_schema.py
          python -m py_compile tests/e2e/test_team_provisioning.py

