name: Test Kratix Team Promise

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
    
    - name: Run unit tests
      run: |
        cd tests
        python -m pytest unit/ -v --tb=short
    
    - name: Run contract tests
      run: |
        cd tests
        python -m pytest contract/ -v --tb=short

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install Kratix CLI
      run: |
        go install github.com/syntasso/kratix-cli/cmd/kratix@latest
        echo "$HOME/go/bin" >> $GITHUB_PATH
    
    - name: Create Kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kratix-test
    
    - name: Install Kratix
      run: |
        kubectl apply -f https://github.com/syntasso/kratix/releases/download/latest/kratix-quick-start-installer.yaml
        
        # Wait for installation to complete
        kubectl wait --for=condition=complete job/kratix-quick-start-installer --timeout=300s
        
        # Verify Kratix is running
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kratix -n kratix-platform-system --timeout=120s
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
    
    - name: Run integration tests
      run: |
        cd tests
        python -m pytest integration/ -v --tb=short
      env:
        KUBECONFIG: /home/runner/.kube/config

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Install Kratix CLI
      run: |
        go install github.com/syntasso/kratix-cli/cmd/kratix@latest
        echo "$HOME/go/bin" >> $GITHUB_PATH
    
    - name: Create Kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kratix-e2e
    
    - name: Install Kratix
      run: |
        kubectl apply -f https://github.com/syntasso/kratix/releases/download/latest/kratix-quick-start-installer.yaml
        
        # Wait for installation to complete
        kubectl wait --for=condition=complete job/kratix-quick-start-installer --timeout=300s
        
        # Verify Kratix is running
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kratix -n kratix-platform-system --timeout=120s
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
    
    - name: Build team-configure container
      run: |
        cd promises/team-promise/workflows/resource/configure/team-configure/python
        docker build -t team-configure:test .
    
    - name: Load container image into Kind
      run: |
        kind load docker-image team-configure:test --name kratix-e2e
    
    - name: Run end-to-end tests
      run: |
        cd tests
        python -m pytest e2e/ -v --tb=short -s
      env:
        KUBECONFIG: /home/runner/.kube/config
        CONTAINER_IMAGE: team-configure:test

  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate YAML files
      run: |
        # Install yq for YAML validation
        sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        
        # Validate Promise YAML
        yq eval '.' promises/team-promise/promise.yaml > /dev/null
        
        # Validate example resource
        yq eval '.' promises/team-promise/example-resource.yaml > /dev/null
        
        # Validate test fixtures
        yq eval '.' tests/unit/fixtures/*.yaml > /dev/null
    
    - name: Validate Dockerfile
      run: |
        # Basic Dockerfile validation
        docker run --rm -i hadolint/hadolint < promises/team-promise/workflows/resource/configure/team-configure/python/Dockerfile || true
    
    - name: Check Python syntax
      run: |
        python -m py_compile promises/team-promise/workflows/resource/configure/team-configure/python/scripts/configure.py
        python -m py_compile tests/unit/test_configure.py
        python -m py_compile tests/integration/test_promise_deployment.py
        python -m py_compile tests/contract/test_api_schema.py
        python -m py_compile tests/e2e/test_team_provisioning.py