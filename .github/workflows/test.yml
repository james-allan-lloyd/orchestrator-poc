name: Test Kratix Team Promise

on:
  push:
    branches: [main, feature/fix-github]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run unit tests
        run: |
          cd tests
          python -m pytest unit/ -v --tb=short
        env:
          PYTHONPATH: ../promises/team-promise/workflows/resource/configure/team-configure/python/scripts

      - name: Run contract tests
        run: |
          cd tests
          python -m pytest contract/ -v --tb=short

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kratix-test
          config: manifests/kind-cluster-config.yaml

      - name: Install Kratix
        run: ./scripts/02-install-kratix.sh

      - name: Debug Kratix install failure
        if: failure()
        run: |
          echo "=== All pods (all namespaces) ==="
          kubectl get pods -A -o wide
          echo ""
          echo "=== Jobs ==="
          kubectl get jobs -A -o wide
          echo ""
          echo "=== Installer job ==="
          kubectl describe job/kratix-quick-start-installer 2>/dev/null || echo "Job not found"
          echo ""
          echo "=== Installer pod logs ==="
          for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs "$pod" --all-containers --tail=80 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Kratix platform pod logs ==="
          for pod in $(kubectl get pods -n kratix-platform-system -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs -n kratix-platform-system "$pod" --all-containers --tail=40 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Events (last 30) ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -30

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run integration tests
        run: |
          cd tests
          python -m pytest integration/ -v --tb=short
        env:
          KUBECONFIG: /home/runner/.kube/config

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kratix-e2e
          config: manifests/kind-cluster-config.yaml

      - name: Install Kratix
        run: ./scripts/02-install-kratix.sh

      - name: Debug Kratix install failure
        if: failure()
        run: |
          echo "=== All pods (all namespaces) ==="
          kubectl get pods -A -o wide
          echo ""
          echo "=== Jobs ==="
          kubectl get jobs -A -o wide
          echo ""
          echo "=== Installer job ==="
          kubectl describe job/kratix-quick-start-installer 2>/dev/null || echo "Job not found"
          echo ""
          echo "=== Installer pod logs ==="
          for pod in $(kubectl get pods --selector=job-name=kratix-quick-start-installer -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs "$pod" --all-containers --tail=80 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Kratix platform pod logs ==="
          for pod in $(kubectl get pods -n kratix-platform-system -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs -n kratix-platform-system "$pod" --all-containers --tail=40 2>/dev/null || echo "No logs"
          done
          echo ""
          echo "=== Events (last 30) ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -30

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Build team-configure container
        run: |
          cd promises/team-promise/workflows/resource/configure/team-configure/python
          docker build -t team-configure:test .

      - name: Load container image into Kind
        run: |
          kind load docker-image team-configure:test --name kratix-e2e

      - name: Run end-to-end tests
        run: |
          cd tests
          python -m pytest e2e/ -v --tb=short -s
        env:
          KUBECONFIG: /home/runner/.kube/config
          CONTAINER_IMAGE: team-configure:test

  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          # Install yq for YAML validation
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Validate Promise YAML
          yq eval '.' promises/team-promise/promise.yaml > /dev/null

          # Validate example resource
          yq eval '.' promises/team-promise/example-resource.yaml > /dev/null

          # Validate test fixtures
          yq eval '.' tests/unit/fixtures/*.yaml > /dev/null

      - name: Validate Dockerfile
        run: |
          # Basic Dockerfile validation
          docker run --rm -i hadolint/hadolint < promises/team-promise/workflows/resource/configure/team-configure/python/Dockerfile || true

      - name: Check Python syntax
        run: |
          python -m py_compile promises/team-promise/workflows/resource/configure/team-configure/python/scripts/configure.py
          python -m py_compile tests/unit/test_configure.py
          python -m py_compile tests/integration/test_promise_deployment.py
          python -m py_compile tests/contract/test_api_schema.py
          python -m py_compile tests/e2e/test_team_provisioning.py

